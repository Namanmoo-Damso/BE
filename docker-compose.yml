services:
  be:
    image: node:20-alpine
    restart: unless-stopped
    # BE 폴더 안에 backend 폴더가 있는 구조라고 가정 (Dockerfile 참조)
    working_dir: /app
    environment:
      NODE_ENV: development
    command: sh -c "npm install && npm run start:dev"
    ports:
      - '8080:8080' # 외부 접속을 위해 포트 개방
    volumes:
      # 호스트의 BE/backend 폴더를 컨테이너의 /app에 마운트
      - .:/app
      # node_modules는 호스트가 아닌 도커 볼륨에 저장 (속도 향상 및 충돌 방지)
      - be_node_modules:/app/node_modules
      - ./secrets:/secrets:ro

  fe:
    image: node:20-alpine
    restart: unless-stopped
    working_dir: /app
    environment:
      NODE_ENV: development
    # Next.js 개발 서버 실행
    command: sh -c "npm install && npm run dev"
    ports:
      - '3000:3000' # 외부 접속을 위해 포트 개방
    volumes:
      # BE 폴더 상위(../)로 나가서 FE 폴더를 마운트
      - ../FE:/app
      - fe_node_modules:/app/node_modules

  # 프록시 서버 및 SSL/TLS 처리
  caddy:
    image: caddy:alpine
    restart: unless-stopped
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - be
      - fe

  db:
    image: postgres:16
    restart: unless-stopped
    env_file:
      - ./.env
    volumes:
      - damso_db_data:/var/lib/postgresql/data
    depends_on:
      - be

volumes:
  be_node_modules:
  fe_node_modules:
  caddy_data:
  caddy_config:
  damso_db_data:
